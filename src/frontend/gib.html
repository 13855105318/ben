<!DOCTYPE html>

<head>
	<title>GIB Bidding</title>

	<!-- CSS -->
	<style>
        body { 
            width: 1000px; /* Set a fixed width for the body element */ 
            margin: 0 auto; /* Center the body element within its parent */ 
        } 
		table {
			border-collapse: collapse;
			width: 800px;
		}

		th,
		td {
			text-align: left;
			padding: 3px;
		}

		tr.us:nth-child(even) {
			background-color: #d4e9d4;
		}
        tr.them:nth-child(even) {
			background-color: #f5f5dc;
		}

		th {
			background-color: #7c0f65;
			color: white;
		}

		td:first-child {
 		   text-align: center; /* Center the content of the first cell in each row */
		}
        /* Basic styles for the bidding diagram */
        .biddingdiagram {
			width: 400px;
            border-collapse: collapse;
            margin: 10px;
            margin-left: 200px;
        }

        .biddingdiagram th, .biddingdiagram td {
            border: 1px solid #000;
			padding: 3px;
            text-align: center;
        }

		.spades { color: black; }
        .hearts { color: red; }
        .diamonds { color: red; }
        .clubs { color: green; }

	</style>

	<!--JavaScript-->
	<script>
        let bid = getQueryParam('bid')
        if (!bid) {
            bid = "*"
        }

        const numOfHyphens = (bid.match(/-/g) || []).length;
        const who = numOfHyphens % 2 === 0 ? 'us' : 'them';

        function getQueryParam(key) {
            const queryString = window.location.search;
            const searchParams = new URLSearchParams(queryString);
            return searchParams.get(key);
        }

		function loadXMLDoc() {
			let xmlhttp = new XMLHttpRequest();
			xmlhttp.onreadystatechange = function () {

				// Request finished and response 
				// is ready and Status is "OK"
				if (this.readyState == 4 && this.status == 200) {
					displayBidDetails(this);
				}
			};

			// employee.xml is the external xml file
			xmlhttp.open("GET", "https://gibrest.bridgebase.com/u_bm/u_bm.php?s=" + bid +"&t=g&v3b=web&v3v=6.19.3&v3u=BBO1", true);
			xmlhttp.send();
		}

		function displayBidDetails(xml) {
			let i;
			let xmlDoc = xml.responseXML;
			let table =	`<tr><th>Bid</th><th>Description</th></tr>`;
			let x = xmlDoc.getElementsByTagName("r");

			// Start to fetch the data by using TagName 
			for (i = x.length; i >0; i--) {
                const bValue = x[i-1].getAttribute('b').toUpperCase();
				if (bValue != "D") {
					bValueHtml = bValue.replace(/S/g, '<span style="color: blue">&spades;</span>');
					bValueHtml = bValueHtml.replace(/H/g, '<span style="color: red">&hearts;</span>');
					bValueHtml = bValueHtml.replace(/D/g, '<span style="color: orange">&diams;</span>');
					bValueHtml = bValueHtml.replace(/C/g, '<span style="color: green">&clubs;</span>');
				} else {
					bValueHtml = bValue;
				}
                const mValue = x[i-1].getAttribute('m');
				mValueHtml = mValue .replace(/!S/g, '<span style="color: blue">&spades;</span>');
				mValueHtml = mValueHtml.replace(/!H/g, '<span style="color: red">&hearts;</span>');
				mValueHtml = mValueHtml.replace(/!D/g, '<span style="color: orange">&diams;</span>');
				mValueHtml = mValueHtml.replace(/!C/g, '<span style="color: green">&clubs;</span>');
				mValueHtml = replaceSuitsBeforeDoubleDash(mValueHtml);
				mValueHtml = replaceSuits(mValueHtml);
				table += "<tr class="+ who + "><td><a href=?bid="+  bid.substring(0,bid.length - 1) + bValue + "-*>" + bValueHtml + "</a></td><td>" + mValueHtml + "</td></tr>";
			}

			// Print the xml data in table form
			document.getElementById("id").innerHTML = table;
		}
				// Define a mapping of card suits to HTML symbols
		const suitMapping = {
			'C': '<span style="color: green">&clubs;</span>', 
			'D': '<span style="color: orange">&diams;</span>', 
			'H': '<span style="color: red">&hearts;</span>',
			'S': '<span style="color: blue">&spades;</span>'
		};

		// Define a function to replace card codes with HTML symbols
		function replaceSuits(text) {
			// Create a regular expression pattern to match card codes
			const pattern = /\b[1-7][CDHS]\b/g;
			
			// Replace function that will use the suitMapping to replace suits
			return text.replace(pattern, (match) => {
				const suit = match[1]; // Extract the suit character (C, D, H, S)
				return match[0] + suitMapping[suit] || match; // Replace with the HTML symbol or leave unchanged
			});
		}

		// Define a function to replace suit symbols only before --
		function replaceSuitsBeforeDoubleDash(text) {

			if (!text.includes('--')) {
    		    return text; // No replacement needed if '--' is not present
    		}
				// Split the text at '--'
			const [beforeDoubleDash, afterDoubleDash] = text.split('--', 2);
			
			// Create a regular expression pattern to match suit symbols alone
			const pattern = /(?<=\s|\(|^)[1-7]?[CDHS](?=\s|\)|$)/g;

			// Replace suits in the part before '--'
			const replacedBeforeDoubleDash = beforeDoubleDash.replace(pattern, (match) => {
				// Extract the suit character (C, D, H, S) based on its position
				const suit = match.match(/[CDHS]/)[0]; // Match the suit character
				return suitMapping[suit] || match; // Replace with the HTML symbol or leave unchanged
			});			
			// Combine the parts back together
			return replacedBeforeDoubleDash + (afterDoubleDash ? '--' + afterDoubleDash : '');
		}		
	</script>
</head>

<body onload="loadXMLDoc()">

	<br><br>
	<h1>GIB Bidding Definitions</h1>
    <h2>Current bidding: </h2>
    <table class="biddingdiagram">
		<tbody id="biddingTable">
            <tr>
                <th width="25%">We</th>
                <th width="25%">They</th>
                <th width="25%">We</th>
                <th width="25%">They</th>
            </tr>
        </tbody>
    </table>
	<br>
    <script>
        function formatBid(bid) {
            return bid.replace(/S/g, '<span class="spades">♠</span>')
                      .replace(/H/g, '<span class="hearts">♥</span>')
                      .replace(/D/g, '<span class="diamonds">♦</span>')
                      .replace(/C/g, '<span class="clubs">♣</span>')
					  .replace(/\*/g, '?');
        }

		// Get the query string from the URL
        const queryString = window.location.search;

        // Create a URLSearchParams object
        const urlParams = new URLSearchParams(queryString);

        // Get the value of the 'bid' parameter
        let bidValue = urlParams.get('bid');

        // Replace the last '*' with '?'
        if (bidValue) {

			const bids = bidValue.split('-');

            // Select the table body
            const biddingTable = document.getElementById('biddingTable');

            // Create rows dynamically
            for (let i = 0; i < bids.length; i += 4) {
                // Create a new row
                const row = document.createElement('tr');

                // Create and populate cells for this row
                for (let j = 0; j < 4; j++) {
                    const cell = document.createElement('td');
                    if (bids[i + j]) {
                        cell.innerHTML = formatBid(bids[i + j]);
                    } else {
                        cell.innerHTML = '&nbsp;';
                    }
                    row.appendChild(cell);
                }

                // Append the row to the table
                biddingTable.appendChild(row);
			}
		}
		</script>
	<table id="id"></table>
</body>

</html>
