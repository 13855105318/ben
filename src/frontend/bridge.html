<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Bridge</title>

  <link rel="stylesheet" href="style.css">
  <script type="text/javascript" src="bridge.js"></script>

</head>

<body>

    <div id="container">
        <div id="north" class="grid-item"></div>
        <div id="auction" class="grid-item"></div>
        <div id="west" class="grid-item"></div>
        <div id="table" class="grid-item">
            <div id="table-container">
                <div class="table-grid-item label-north">
                    <span class="seat-label">N</span>
                </div>
                <div class="table-grid-item label-west">
                    <div class="seat-label">W</div>
                </div>
                <div class="table-grid-item trick-west">
                </div>
                <div class="table-grid-item trick-north">
                </div>
                <div class="table-grid-item trick-east">
                </div>
                <div class="table-grid-item label-east">
                    <div class="seat-label">E</div>
                </div>
                <div class="table-grid-item trick-south">
               </div>
                <div class="table-grid-item label-south">
                    <div class="seat-label">S</div>
                </div>
            </div>
        </div>
        <div id="east" class="grid-item"></div>
        <div id="south" class="grid-item"></div>
        <div id="bidding" class="grid-item"></div>
    </div>

    <div id="claim" style="display: none">
        <div id="claim-tricks">
            <div tricks="0">0</div>
            <div tricks="1">1</div>
            <div tricks="2">2</div>
            <div tricks="3">3</div>
            <div tricks="4">4</div>
            <div tricks="5">5</div>
            <div tricks="6">6</div>
            <div tricks="7">7</div>
        </div>
    </div>

    <div><a href="/home">Home</a></div>

    <div id="auctionstr"></div>


    <script type="text/javascript">
        console.log('starting')

        let timeoutId
        const urlParams = new URLSearchParams(location.search)
        const dealId = urlParams.get("deal")
        const north = urlParams.get("N")
        const east = urlParams.get("E")
        const south = urlParams.get("S")
        const west = urlParams.get("W")
        const humandeclares = urlParams.get("H")
        const autocomplete = urlParams.get("A")
        const board_no = urlParams.get("board_no")
        let no_human = !north && !east && !south && !west
        let player = ""
        if (north) player += "&N=x"
        if (east) player += "&E=x"
        if (south) player += "&S=x"
        if (west) player += "&W=x"
        if (humandeclares) player += "&H=x"
        if (autocomplete) player += "&A=x"
        var queryString = ""
        var ws
        if (dealId) {
            queryString = "?deal=" + dealId + "&board_no=" + board_no + player
        } else {
            queryString = "?board_no=" + board_no + player
        }
        try {

            var protocol = location.protocol === 'https:' ? 'wss://' : 'ws://';
            var port = location.port !== '' ? ':' + location.port : ''; // Extracts the port number, if present
            ws = new WebSocket(protocol + location.hostname + ":4443/" + queryString)

            ws.addEventListener("error", function (event) {
                console.log("WebSocket error:", event);
                document.querySelector('#auctionstr').innerHTML += 'No connection to server <br>'
            });

            ws.addEventListener("close", function (event) {
                console.log("WebSocket closed:", event);
                document.querySelector('#auctionstr').innerHTML += 'Connection to server closed <br>'
            });

        } catch(error) {
            console.log("WebSocket error:", error);
            alert("Please start server", error); // Notify the user about the connection failure            
        }

        var deal

        function getTrickCardSlots() {
            return [
                document.querySelector('.trick-north'),
                document.querySelector('.trick-east'),
                document.querySelector('.trick-south'),
                document.querySelector('.trick-west')
            ]
        }

        function setTurn(playerTurn) {
            let labels = ['.label-north', '.label-east', '.label-south', '.label-west']
            labels.forEach(l => document.querySelector(l + ' .seat-label').classList.remove("turn"))
            document.querySelector(labels[playerTurn] + ' .seat-label').classList.add("turn")
        }

        function cardClick(event) {
            console.log('card click')
            if (deal.expectCardInput) {
                let card = new Card(event.target.getAttribute('symbol'))
                if (deal.hands[deal.turn]) {
                    if (deal.hands[deal.turn].isPlayable(card, deal.currentTrick)) {
                        ws.send(card.symbol)
                        deal.expectCardInput = false
                        return
                    } 
                }

                console.log(card, "not in hand")
            }
        }

        function biddingLevelClick(event) {
            if (!deal.expectBidInput || event.target.classList.contains("invalid")) {
                return
            }
            document.querySelectorAll('#bidding-levels div').forEach(el => el.classList.remove("selected"))
            document.querySelectorAll('#bidding-suits div').forEach(el => el.classList.remove("invalid"))
            document.querySelectorAll('#claim-tricks div').forEach(el => el.classList.remove("invalid"))
            event.target.classList.add("selected")

            let level = parseInt(event.target.textContent)
            let auction = new Auction(deal.dealer, deal.vuln, deal.auction)
            let minBiddableSuit = auction.getMinBiddableSuitForLevel(level)

            document.querySelector('#bidding-suits').classList.remove("hidden")

            let bidSuitClasses = ['.bid-clubs', '.bid-diamonds', '.bid-hearts', '.bid-spades', '.bid-nt']

            for (var i = 0; i < minBiddableSuit; i++) {
                document.querySelector(bidSuitClasses[i]).classList.add("invalid")
            }
            
        }

        function callClick(event) {
            if (!deal.expectBidInput || event.target.classList.contains("invalid")) {
                return
            }
            ws.send(event.target.textContent)
            deal.expectBidInput = false
        }

        function bidSuitClick(event) {
            if (!deal.expectBidInput || event.target.classList.contains("invalid")) {
                return
            }

            let level = document.querySelector('#bidding-levels .selected').textContent
            let bid = level + event.target.getAttribute("symbol")
            console.log(bid)

            ws.send(bid)

            deal.expectBidInput = false
        }

        function claimClick(event) {

            let claim = event.target.getAttribute("tricks")
            console.log("Claimed "+claim+ " tricks")
            alert("Claim not implemented")
            //ws.send(claim)
            deal.expectCardInput = true
        }

        document.querySelector('body').addEventListener('click', function() {
            // THis could also be a claim - need handling
            if (deal?.expectTrickConfirm) {
                getTrickCardSlots().forEach(el => el.textContent = "")
                ws.send('y')
                if (timeoutId) clearTimeout(timeoutId);
                deal.expectTrickConfirm = false
                if (deal.renderClaim(document.querySelector("#claim"))) {
                    document.querySelector('#claim').style.display = 'block'
                    document.querySelectorAll('#claim-tricks div').forEach(el =>
                        el.addEventListener("click", claimClick))
                }
            }
        })


        ws.onmessage = function (event) {
            console.log('received message')
            console.log(event.data)

            let data = JSON.parse(event.data)

            if (data.message == "deal_start") {
                deal = new Deal(data.dealer, data.vuln, data.hand)

                let dealerLabel = ['.label-north', '.label-east', '.label-south', '.label-west'][deal.dealer]

                document.querySelector(dealerLabel + ' .seat-label').classList.add("dealer")
                if (deal.vuln[0]) {
                    document.querySelector('.label-north .seat-label').classList.add("red")
                    document.querySelector('.label-south .seat-label').classList.add("red")
                }
                if (deal.vuln[1]) {
                    document.querySelector('.label-west .seat-label').classList.add("red")
                    document.querySelector('.label-east .seat-label').classList.add("red")
                }

                setTurn(deal.dealer)

                if (north || no_human) deal.hands[0].render(document.querySelector('#north'))
                if (east || no_human) deal.hands[1].renderEW(document.querySelector('#east'))
                if (south || no_human) deal.hands[2].render(document.querySelector('#south'))
                if (west || no_human) deal.hands[3].renderEW(document.querySelector('#west'))
                deal.renderAuction(document.querySelector('#auction'))
                deal.renderBiddingBox(document.querySelector('#bidding'))
            } else if (data.message == "bid_made") {
                deal.auction = data.auction
                deal.renderAuction(document.querySelector('#auction'))
                deal.turn = (deal.turn + 1) % 4
            } else if (data.message == "get_bid_input") {
                deal.auction = data.auction
                deal.canDouble = data.can_double
                deal.canRedouble = data.can_redouble
                deal.expectBidInput = true
                deal.renderBiddingBox(document.querySelector('#bidding'))

                document.querySelectorAll('#bidding-calls div').forEach(el =>
                    el.addEventListener("click", callClick))
                document.querySelectorAll('#bidding-levels div').forEach(el =>
                    el.addEventListener("click", biddingLevelClick))
                document.querySelectorAll('#bidding-suits div').forEach(el =>
                    el.addEventListener("click", bidSuitClick))
            } else if (data.message == "auction_end") {
                deal.auction = data.auction
                deal.declarer = data.declarer
                deal.strain = data.strain
                deal.dummy = (deal.declarer + 2) % 4
                deal.turn = (data.declarer + 1) % 4
                setTurn(deal.turn)
                deal.currentTrick = new Trick(deal.turn, [])

                //document.querySelector('#north').textContent = ''
                document.querySelector('#bidding').textContent = ''
                deal.renderAuction(document.querySelector('#auction'))

                document.querySelectorAll('.card')
                    .forEach(c => c.addEventListener('click', cardClick))
            } else if (data.message == "show_dummy") {

                deal.hands[data.player] = parseHand(data.dummy)

                if (data.player == 0) deal.hands[data.player].render(document.querySelector('#north'))
                if (data.player == 1) deal.hands[data.player].renderEW(document.querySelector('#east'))
                if (data.player == 2) deal.hands[data.player].render(document.querySelector('#south'))
                if (data.player == 3) deal.hands[data.player].renderEW(document.querySelector('#west'))

                document.querySelectorAll('.card')
                    .forEach(c => c.addEventListener('click', cardClick))
            } else if (data.message == "card_played") {
                let card = new Card(data.card)
                
                deal.currentTrick.cards.push(card)

                if (no_human) {
                    deal.hands[data.player] = deal.hands[data.player].play(card)
                    if (data.player == 0) deal.hands[0].render(document.querySelector('#north'))
                    if (data.player == 1) deal.hands[1].renderEW(document.querySelector('#east'))
                    if (data.player == 2) deal.hands[2].render(document.querySelector('#south'))
                    if (data.player == 3) deal.hands[3].renderEW(document.querySelector('#west'))
                } else {
                    // First check if dummy is to be updated
                    if (data.player == deal.dummy) {
                        deal.hands[data.player] = deal.hands[data.player].play(card)
                        if (deal.dummy == 0) {
                            deal.hands[data.player].render(document.querySelector('#north'))
                        } 
                        if (deal.dummy == 1) {
                            deal.hands[data.player].renderEW(document.querySelector('#east'))
                        } 
                        if (deal.dummy == 2) {
                            deal.hands[data.player].render(document.querySelector('#south'))
                        } 
                        if (deal.dummy == 3) {
                            deal.hands[data.player].renderEW(document.querySelector('#west'))
                        }
                    } else {
                        if (deal.hands[data.player]) {
                            // Then check if declarer is human
                            deal.hands[data.player] = deal.hands[data.player].play(card)
                            if (data.player == 0 && north) {
                                deal.hands[data.player].render(document.querySelector('#north'))
                            } 
                            if (data.player == 1 && east) {
                                deal.hands[data.player].renderEW(document.querySelector('#east'))
                            } 
                            if (data.player == 2 && south) {
                                deal.hands[data.player].render(document.querySelector('#south'))
                            } 
                            if (data.player == 3 && west) {
                                deal.hands[data.player].renderEW(document.querySelector('#west'))
                            } 
                            // Finally we need to update declarer if we are dummy
                            if (data.player == 0 && deal.declarer == data.player && south) {
                                deal.hands[data.player].render(document.querySelector('#north'))
                            } 
                            if (data.player == 1 && deal.declarer == data.player && west) {
                                deal.hands[data.player].renderEW(document.querySelector('#east'))
                            } 
                            if (data.player == 2 && deal.declarer == data.player && north) {
                                deal.hands[data.player].render(document.querySelector('#south'))
                            } 
                            if (data.player == 3 && deal.declarer == data.player && east) {
                                deal.hands[data.player].renderEW(document.querySelector('#west'))
                            } 
                        }
                    }
                }
                document.querySelectorAll('.card')
                    .forEach(c => c.addEventListener('click', cardClick))
                deal.currentTrick.render(getTrickCardSlots())
                deal.turn = (data.player + 1) % 4
                setTurn(deal.turn)
            } else if (data.message == "get_card_input") {
                deal.expectCardInput = true
            } else if (data.message == "trick_confirm") {
                let trickWinner = deal.currentTrick.winner(deal.strain)
                console.log('trick won by ', trickWinner)

                deal.turn = trickWinner
                setTurn(deal.turn)
                deal.tricks.push(deal.currentTrick)
                deal.currentTrick = new Trick(trickWinner, [])

                deal.tricksCount[trickWinner % 2] += 1

                deal.renderTricks(document.querySelector('.tricks'))
                deal.expectTrickConfirm = true
                if (autocomplete) {
                    // After 5 seconds, set expectTrickConfirm to false
                    timeoutId = setTimeout(function() {
                        if (deal.expectTrickConfirm) {
                            deal.expectTrickConfirm = false;
                            getTrickCardSlots().forEach(el => el.textContent = "")
                            ws.send('y')
                        }
                    }, 5000); 
                }
            } else if (data.message == "deal_end") {
                let handsPBN = data.pbn.split(' ')
                let north = parseHand(handsPBN[0])
                let east = parseHand(handsPBN[1])
                let south = parseHand(handsPBN[2])
                let west = parseHand(handsPBN[3])

                north.render(document.querySelector('#north'))
                south.render(document.querySelector('#south'))
                east.renderEW(document.querySelector('#east'))
                west.renderEW(document.querySelector('#west'))

                deal.renderAuction(document.querySelector('#auction'))
                saveDeal(data.dict)

            }
        };

        function saveDeal(dict) {
            // Convert JavaScript object to JSON string
            const dataStr = JSON.stringify(dict);

             // Make a POST request
            fetch('/api/save/deal', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: dataStr,
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                console.log('Deal saved');
                return response.json();
            })
            .then(data => {
                // Redirect to another page after successful POST
                window.location.href = '/home';
            })
            .catch(error => {
                console.error('There was a problem with the fetch operation:', error);
            });
        }

    </script>  

    
</body>